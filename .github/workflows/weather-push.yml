name: 每日早间简报推送
on:
  workflow_dispatch:
  schedule:
    - cron: '00 0 * * *'

jobs:
  weather-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: 记录开始时间
        run: |
          echo "=========================================="
          echo "天气预报推送任务开始"
          echo "开始时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
      
      - name: 调用天气预报工作流
        id: call_workflow
        continue-on-error: true
        run: |
          echo "正在调用天气预报工作流..."
          RESPONSE=$(curl --location --request POST 'https://nsv7pch2sn.coze.site/run' \
            --header 'Authorization: Bearer ${{ secrets.COZE_API_TOKEN }}' \
            --header 'Content-Type: application/json' \
            --data '{}')
          
          echo "API 响应:"
          echo "$RESPONSE"
          
          # 保存响应到环境变量
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          
          # 检查响应状态
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "✅ 天气推送成功"
            exit 0
          else
            echo "❌ 天气推送失败"
            exit 1
          fi
      
      - name: 记录成功日志
        if: success()
        run: |
          echo "$(date '+%Y-%m-%d %H:%M:%S'): ✅ 天气推送成功" >> workflow.log
          echo "=========================================="
          echo "天气预报推送任务成功"
          echo "结束时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
          cat workflow.log
      
      - name: 记录失败日志
        if: failure()
        run: |
          echo "$(date '+%Y-%m-%d %H:%M:%S'): ❌ 天气推送失败" >> workflow.log
          echo "=========================================="
          echo "天气预报推送任务失败"
          echo "结束时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "响应内容:"
          echo "${{ steps.call_workflow.outputs.response }}"
          echo "=========================================="
          cat workflow.log
      
      - name: 上传日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weather-push-log-${{ github.run_number }}
          path: workflow.log
          retention-days: 30
