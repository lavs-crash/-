name: æ¯æ—¥æ—©é—´ç®€æŠ¥æ¨é€

on:
  schedule:
    # æ¯å¤© UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰æ‰§è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  weather-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€æµ‹æ—¶åŒºå’Œæ—¶é—´
        run: |
          echo "=========================================="
          echo "ğŸ• æ—¶åŒºæ£€æµ‹"
          echo "=========================================="
          echo "UTC æ—¶é—´:"
          date -u '+%Y-%m-%d %H:%M:%S %Z'
          echo "ç³»ç»Ÿæ—¶é—´:"
          date '+%Y-%m-%d %H:%M:%S %Z'
          echo "æ—¶åŒºä¿¡æ¯:"
          date '+%z %Z'
          echo "=========================================="
      
      - name: è®°å½•å¼€å§‹æ—¶é—´
        run: |
          echo "=========================================="
          echo "ğŸ“… å¤©æ°”é¢„æŠ¥æ¨é€ä»»åŠ¡å¼€å§‹"
          echo "å¼€å§‹æ—¶é—´(UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "å¼€å§‹æ—¶é—´(æœ¬åœ°): $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
      
      - name: è°ƒç”¨å¤©æ°”é¢„æŠ¥å·¥ä½œæµ
        id: call_workflow
        continue-on-error: true
        run: |
          echo "æ­£åœ¨è°ƒç”¨å¤©æ°”é¢„æŠ¥å·¥ä½œæµ..."
          RESPONSE=$(curl --location --request POST 'https://nsv7pch2sn.coze.site/run' \
            --header 'Authorization: Bearer ${{ secrets.COZE_API_TOKEN }}' \
            --header 'Content-Type: application/json' \
            --data '{}')
          
          echo "API å“åº”:"
          echo "$RESPONSE"
          
          # ä¿å­˜å“åº”åˆ°ç¯å¢ƒå˜é‡
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥å“åº”çŠ¶æ€
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "âœ… å¤©æ°”æ¨é€æˆåŠŸ"
            exit 0
          else
            echo "âŒ å¤©æ°”æ¨é€å¤±è´¥"
            exit 1
          fi
      
      - name: è®°å½•æˆåŠŸæ—¥å¿—
        if: success()
        run: |
          echo "$(date '+%Y-%m-%d %H:%M:%S'): âœ… å¤©æ°”æ¨é€æˆåŠŸ" >> workflow.log
          echo "=========================================="
          echo "ğŸ“… å¤©æ°”é¢„æŠ¥æ¨é€ä»»åŠ¡æˆåŠŸ"
          echo "ç»“æŸæ—¶é—´(UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ç»“æŸæ—¶é—´(æœ¬åœ°): $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
          cat workflow.log
      
      - name: è®°å½•å¤±è´¥æ—¥å¿—
        if: failure()
        run: |
          echo "$(date '+%Y-%m-%d %H:%M:%S'): âŒ å¤©æ°”æ¨é€å¤±è´¥" >> workflow.log
          echo "=========================================="
          echo "âŒ å¤©æ°”é¢„æŠ¥æ¨é€ä»»åŠ¡å¤±è´¥"
          echo "ç»“æŸæ—¶é—´(UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ç»“æŸæ—¶é—´(æœ¬åœ°): $(date '+%Y-%m-%d %H:%M:%S')"
          echo "å“åº”å†…å®¹:"
          echo "${{ steps.call_workflow.outputs.response }}"
          echo "=========================================="
          cat workflow.log
      
      - name: ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weather-push-log-${{ github.run_number }}
          path: workflow.log
          retention-days: 30
